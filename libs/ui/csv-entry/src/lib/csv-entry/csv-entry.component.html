<div class="c-csv-entry qa-csv-entry">

  <div class="c-csv-entry__info qa-csv-entry-info">
    {{ rows.length }} row{{ rows.length === 1 ? '' : 's' }}
    <br>
    {{ columnCount }} column{{ columnCount === 1 ? '' : 's' }}
  </div>

  <div class="c-csv-entry__scroll">
    <!-- NOTE: fxLayout cannot be defined on the scroll container -->
    <div fxLayout="row">

      <!-- Column for delete buttons -->
      <div fxLayout="column">
        <!-- Fake row for header -->
        <div [style.height]="fakeRowHeight" fxFlex="0 0 auto"></div>

        <div
          class="c-csv-entry__column-id"
          [class.c-csv-entry__column-id--invalid]="row.invalid"
          [attr.id]="'csv-row-id-' + (idIndex + 1)"
          *ngFor="let row of rows?.controls; let idIndex = index"
          fxFlex="0 0 auto"
          fxLayout="row"
          fxLayoutAlign="center center"
        >
          <span fxFlex>
            {{ +row.controls?.recordId?.value + 1 }}
          </span>
        </div>
      </div>

      <!-- Content -->
      <form
        class="c-csv-entry__form"
        [formGroup]="recordsForm"
        fxFlex
        #form
        (mousewheel)="onScroll($event)"
      >

        <!-- Header Cells -->
        <div
          class="c-csv-entry__row c-csv-entry__row--header qa-csv-entry-header-row"
          formArrayName="headers"
        >
          <input
            class="c-csv-entry__input c-csv-entry__input--header qa-csv-entry-header-cell"
            type="text"
            title="Header, Column: {{ getHeaderCellName(headerIndex) || headerIndex + 1 }}"
            [readonly]="(columnHeaders && columnHeaders[headerIndex])"
            *ngFor="let c of headerCells?.controls; let headerIndex = index"
            [attr.id]="createId(-1, headerIndex)"
            [formControlName]="headerIndex"
            (paste)="onPaste($event, true)"
            (keydown.enter)="selectCellInNextRow(createId(-1, headerIndex))"
            (keydown.tab)="selectAdjacentCell($event, createId(-1, headerIndex))"
            (keydown.shift.tab)="selectAdjacentCell($event, createId(-1, headerIndex), true)"
          >
        </div>


        <!-- Body Rows -->
        <div formArrayName="records">
          <div
            class="c-csv-entry__row qa-csv-entry-row"
            *ngFor="let record of rows?.controls; let recordIndex = index"
            [formGroupName]="recordIndex"
          >
            <div formArrayName="columns" class="c-csv-entry__row--inner">
              <input
                *ngFor="let c of getColumns(record)?.controls; let columnIndex = index"
                class="c-csv-entry__input qa-csv-entry-cell"
                [class.c-csv-entry__input--invalid]="c.invalid"
                type="text"
                title="Row: {{ record.controls?.recordId?.value + 1 }}, Column: {{ getHeaderCellName(columnIndex) || columnIndex + 1 }}"
                [attr.id]="createId(recordIndex, columnIndex)"
                [formControlName]="columnIndex"
                (paste)="onPaste($event)"
                (keydown.enter)="selectCellInNextRow(createId(recordIndex, columnIndex))"
                (keydown.shift.enter)="selectCellInNextRow(createId(recordIndex, columnIndex), true)"
                (keyup)="updateErrors()"
                (keydown.tab)="selectAdjacentCell($event, createId(recordIndex, columnIndex))"
                (keydown.shift.tab)="selectAdjacentCell($event, createId(recordIndex, columnIndex), true)"
              >
            </div>
          </div>
        </div>
      </form>


      <!-- Column for delete buttons -->
      <div fxLayout="column">
        <!-- Fake row for header -->
        <div [style.height]="fakeRowHeight"  fxFlex="0 0 auto"></div>

        <button
          class="c-csv-entry__delete"
          [attr.id]="'csv-delete-' + (deleteIndex + 1)"
          [attr.title]="'Delete row ' + (deleteIndex + 1)"
          *ngFor="let row of rows?.controls; let deleteIndex = index;"
          (click)="deleteRow(deleteIndex)"
        >
          <svg
            aria-hidden="true"
            focusable="false"
            data-prefix="fas"
            data-icon="trash"
            role="img"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 448 512"
          >
            <path
              fill="currentColor"
              d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"
            ></path>
          </svg>
        </button>
      </div>

    </div>
  </div>


  <!-- Validation messages -->
  <div
    class="c-csv-entry__messages"
    fxLayout="column"
    fxLayoutAlign="start stretch"
    [fxLayoutGap]="layoutGap"
  >
    <div fxLayout="column" fxLayoutAlign="center end">
      <div
        class="c-csv-entry__message qa-csv-entry-message"
        *ngFor="let message of validationMessages; let i = index"
        [innerHTML]="message"
      ></div>
      <div
        class="c-csv-entry__message qa-csv-entry-message"
        *ngIf="tooManyRowsMessage"
      >{{ tooManyRowsMessage }}</div>
    </div>

    <div fxLayout="row" [dir]="footerDirection" fxLayoutAlign="space-between center" [fxLayoutGap]="layoutGap">
      <div dir="ltr" fxFlex="2 1">
        <ts-button
          id="ts-csv-reset"
          class="qa-csv-entry-reset"
          theme="warning"
          (clicked)="resetTable()"
        >Reset Table</ts-button>

        <ts-button
          id="ts-csv-add-row"
          class="qa-csv-entry-add-row"
          theme="secondary"
          (clicked)="addRows()"
        >Add Row</ts-button>
      </div>

      <span fxFlex></span>

      <div dir="ltr">
        <ng-content></ng-content>
      </div>
    </div>
  </div>
</div>
